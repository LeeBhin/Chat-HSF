<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>고등학교 찾아주는 봇</title>
  <meta name="description" content="고등학교 찾기 힘드시죠? 원하는 조건을 채팅으로 입력하여 마음에 드는 고등학교를 손쉽게 찾아보세요!">
  <link rel="stylesheet" href="src/css/chatpage.css" />
  <link rel="icon" href="src/images/search.png" />
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3c4fd18abcfe2b56a5bed9cceb72ece5"></script>
</head>

<body>
  <div id="mbheader">
    <svg xmlns="http://www.w3.org/2000/svg" id="hbgbtn" width="20px" height="20px"
      viewBox="0 0 448 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
      <path
        d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z" />
    </svg>
    고등학교 찾아드립니다
  </div>

  <header>
    <button id="apiReload" onclick="apiupdate(); window.location.reload();">
      <span><svg xmlns="http://www.w3.org/2000/svg" width="16px"
          viewBox="0 0 512 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
          <path
            d="M386.3 160H336c-17.7 0-32 14.3-32 32s14.3 32 32 32H464c17.7 0 32-14.3 32-32V64c0-17.7-14.3-32-32-32s-32 14.3-32 32v51.2L414.4 97.6c-87.5-87.5-229.3-87.5-316.8 0s-87.5 229.3 0 316.8s229.3 87.5 316.8 0c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0c-62.5 62.5-163.8 62.5-226.3 0s-62.5-163.8 0-226.3s163.8-62.5 226.3 0L386.3 160z" />
        </svg>정보 갱신</span>
    </button>

    <div id="log">log</div>
    <div id="logs"></div>

    <svg xmlns="http://www.w3.org/2000/svg" width="15px" height="15px" id="xbtn"
      viewBox="0 0 384 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
      <path fill="#ffffff"
        d="M376.6 84.5c11.3-13.6 9.5-33.8-4.1-45.1s-33.8-9.5-45.1 4.1L192 206 56.6 43.5C45.3 29.9 25.1 28.1 11.5 39.4S-3.9 70.9 7.4 84.5L150.3 256 7.4 427.5c-11.3 13.6-9.5 33.8 4.1 45.1s33.8 9.5 45.1-4.1L192 306 327.4 468.5c11.3 13.6 31.5 15.4 45.1 4.1s15.4-31.5 4.1-45.1L233.7 256 376.6 84.5z" />
    </svg>
  </header>
  <div id="mbblck"></div>

  <div id="chatpage">
    <div id="down" class="updn" onclick="scrollToBottom()">
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"
        viewBox="0 0 384 512"><!--!Font Awesome Free 6.5.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free Copyright 2024 Fonticons, Inc.-->
        <path
          d="M169.4 470.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 370.8 224 64c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 306.7L54.6 265.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" />
      </svg>
    </div>


    <div id="ex">
      <img src="src/images/search.png" alt="" class="exlogo" />
      <h1 id="title">어떤 학교를 찾고 계신가요?</h1>


    </div>
    <div id="exfx">
      <div id="exul" class="hv">
        <div id="extxt" class="mb" onclick="ex(this)">
          <strong>지역, 종류, 성별로 고등학교 찾기</strong>
          <p>"서울 특성화고 남녀공학"</p>
        </div>
        <div id="extxt" onclick="ex(this)">
          <strong>데이터 수동으로 업데이트하기</strong>
          <p>"!업데이트"</p>
        </div>
      </div>


      <div id="exul">
        <div id="extxt" class="mb" onclick="ex(this)">
          <strong>이름으로 고등학교 찾기</strong>
          <p>"세명컴퓨터고등학교 / 세명컴고"</p>
        </div>
        <div id="extxt" onclick="ex(this)">
          <strong>사용 설명서 보기</strong>
          <p>"!설명서"</p>
        </div>
      </div>
    </div>

    <div id="search">
      <input type="text" class="searchbar" placeholder="손쉽게 고등학교 찾기..." id="searchbar" autocomplete="off" />


      <!-- <img src="send.png" alt="" id="sendimg" onclick="pbchk()"> -->
    </div>
  </div>


  <div id="code" style="display: none"></div>
  <div id="answertype" style="display: none"></div>


  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script type="module" src="src/js/chatpage.js"></script>
</body>


<script>
  const openDB = () => {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('myDatabase', 1);

      request.onerror = (event) => {
        reject('Failed to open database');
      };

      request.onsuccess = (event) => {
        const db = event.target.result;
        resolve(db);
      };

      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('data')) {
          const objectStore = db.createObjectStore('data', { keyPath: 'id' });
        }
      };
    });
  };

  const fetchDataFromAPI = async () => {
    try {
      const response = await axios.get('/.netlify/functions/api');
      const data = response.data;
      const schinfo = data[0].list;
      const stdnt = data[1].list;
      const currentTime = new Date().getTime();

      const db = await openDB();
      const transaction = db.transaction('data', 'readwrite');
      const objectStore = transaction.objectStore('data');

      await Promise.all([
        objectStore.put({ id: 'schinfo', data: schinfo }),
        objectStore.put({ id: 'stdnt', data: stdnt }),
        objectStore.put({ id: 'lastUpdated', data: currentTime }),
      ]);

      console.log('Data saved to IndexedDB successfully');
      location.reload();
    } catch (error) {
      alert('오류가 발생했습니다. 새로고침해주세요.\n' + error);
      location.reload();
    }
  };

  const checkAndUpdateData = async () => {
    const db = await openDB();
    const transaction = db.transaction('data', 'readonly');
    const objectStore = transaction.objectStore('data');

    const schinfoRequest = objectStore.get('schinfo');
    schinfoRequest.onsuccess = (event) => {
      const schinfo = event.target.result;

      const stdntRequest = objectStore.get('stdnt');
      stdntRequest.onsuccess = (event) => {
        const stdnt = event.target.result;

        const lastUpdatedRequest = objectStore.get('lastUpdated');
        lastUpdatedRequest.onsuccess = (event) => {
          const lastUpdated = event.target.result;

          const currentTime = new Date().getTime();
          const oneWeekInMilliseconds = 7 * 24 * 60 * 60 * 1000;

          if (
            schinfo === undefined ||
            stdnt === undefined ||
            lastUpdated === undefined ||
            currentTime - parseInt(lastUpdated.data) >= oneWeekInMilliseconds
          ) {
            fetchDataFromAPI();
          }
        };
      };
    };
  };

  checkAndUpdateData();

  const scrollContainer = document.getElementById('chatpage');
  const targetDiv = document.getElementById('down');

  scrollContainer.addEventListener('scroll', function () {
    // 스크롤 대상의 현재 스크롤 위치와 높이를 계산합니다.
    const scrollHeight = scrollContainer.scrollHeight;
    const scrollTop = scrollContainer.scrollTop;
    const clientHeight = scrollContainer.clientHeight;

    // 스크롤이 바닥에 도달했는지 확인합니다.
    const isAtBottom = scrollHeight - scrollTop === clientHeight;

    // 스크롤이 바닥에 도달했다면 targetDiv를 숨기고, 그렇지 않다면 다시 표시합니다.
    if (isAtBottom) {
      targetDiv.style.display = 'none';
    } else {
      targetDiv.style.display = 'block';
    }
  });

  function scrollToBottom() {
    window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
  }

  function scrollToBottom() {
    ph = document.getElementById("chatpage").scrollHeight;
    document.getElementById("chatpage").scrollTo({
      top: ph,
      behavior: "smooth",
    });
  }

  // 검색창에 예시 문장 추가하는 함수
  function ex(element) {
    functionMsg = element.innerText.split('\n')[2]
    if (functionMsg.includes('/')) {
      functionMsg = functionMsg.split('/')[0]
    }
    document.getElementById("searchbar").value = functionMsg
      .replace(/["]/g, "")
      .trim();
  }

  // 지도와 로드뷰를 감싸고 있는 div의 class를 변경하여 지도를 숨기거나 보이게 하는 함수입니다
  function toggleMap(active, clickedButton) {
    // 클릭한 버튼 요소의 부모 요소를 찾습니다.
    var container = clickedButton.closest("#container");

    if (container) {
      if (active) {
        container.className = "view_map"; // 지도가 보이도록 클래스 변경
      } else {
        container.className = "view_roadview"; // 로드뷰가 보이도록 클래스 변경
      }
    }
  }

  async function apiupdate() {
    const db = await openDB();
    const transaction = db.transaction("data", "readwrite");
    const objectStore = transaction.objectStore("data");

    objectStore.delete("schinfo");
    objectStore.delete("stdnt");
    objectStore.delete("lastUpdated");

    window.location.reload();
  }

  const header = document.querySelector("header");
  const toggleButton = document.getElementById("hbgbtn");
  const xbtn = document.getElementById("xbtn");
  const mbblck = document.getElementById("mbblck");
  let isOpen = false;

  // 햄버거 버튼 클릭 이벤트
  toggleButton.addEventListener("click", () => {
    if (!isOpen) {
      header.style.transform = "translateX(0)";
      toggleButton.style.display = "none";
      xbtn.style.display = "block";
      mbblck.style.display = "block";
      setTimeout(() => {
        xbtn.style.transform = "translateX(1030%)";
      }, 10);
    }
    isOpen = true;
  });

  // 닫기 버튼 클릭 이벤트
  xbtn.addEventListener("click", () => {
    closeMenu();
  });

  // 메뉴 닫는 기능을 함수로 분리
  function closeMenu() {
    isOpen = false;
    header.style.transform = "translateX(-100%)";
    toggleButton.style.display = "block";
    xbtn.style.display = "none";
    mbblck.style.display = "none";
  }

  // 화면 크기 변경에 따른 이벤트 리스너
  window.addEventListener("resize", () => {
    if (window.innerWidth >= 768) {
      // 화면이 768px 이상이면 메뉴 및 버튼 초기화
      header.style.transform = "translateX(0)";
      toggleButton.style.display = "block";
      xbtn.style.display = "none";
      mbblck.style.display = "none";
      isOpen = false; // 메뉴 상태 초기화
    } else if (!isOpen) {
      // 화면이 768px 미만이고 메뉴가 닫혀있으면 header 숨기기
      header.style.transform = "translateX(-100%)";
    }
  });

  // 초기 로드 시 화면 크기 체크
  if (window.innerWidth >= 768) {
    closeMenu(); // 초기 상태에서 화면이 넓으면 메뉴 닫기
  }
</script>


</html>
