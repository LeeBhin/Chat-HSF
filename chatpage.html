<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New chat</title>
    <link rel="stylesheet" href="src/css/chatpage.css">
    <link rel="icon" href="src/images/search.png">

    <script type="text/javascript"
        src="//dapi.kakao.com/v2/maps/sdk.js?appkey=3c4fd18abcfe2b56a5bed9cceb72ece5"></script>
</head>

<body>
    <div id="up" class="updn" onclick="scrollToTop()">↑</div>
    <div id="down" class="updn" onclick="scrollToBottom()">↓</div>
    <header>
        <button id="apiReload" onclick="apiupdate(); window.location.reload();">
            <span>♻️ &nbsp; 정보 갱신</span>
        </button>

        <div id="log">log</div>

        <div id="logs">

        </div>
    </header>

    <div id="chatpage">
        <div id="mbblck"
            style="width: 100%; height: 100%; position: absolute; background-color: rgba(35, 35, 56, 0.418); z-index: 100; display: none; ">
        </div>
        <div id="mbheader">
            <img src="src/images/hmbgr.png" alt="" id="hbgbtn"
                style="width: 25px; position: absolute; left: 10px; top: 13px; cursor: pointer; z-index: 1000; filter: opacity(0.5) drop-shadow(0 0 0 #000000);">
            <img src="src/images/xbtn.png" alt="" id="xbtn"
                style="width: 25px; position: absolute; left: 10px; top: 13px; cursor: pointer; display: none; z-index: 1000;">
            New chat
        </div>


        <div id="ex">
            <img src="src/images/search.png" alt="" class="exlogo">
            <h1 id="title">어떤 학교를 찾고 계신가요?</h1>

            <div id="exfx">

                <div id="exul" class="hv">
                    <div id="extxt" class="mb" onclick="ex(this)"><strong>지역으로 고등학교 찾기</strong>
                        <p>"서울특별시 / 서울 / 경상남도 / 전국"</p>
                    </div>
                    <div id="extxt" onclick="ex(this)"><strong>종류로 고등학교 찾기</strong>
                        <p>"특성화고 / 일반고 / 특목고"</p>
                    </div>
                </div>

                <div id="exul">
                    <div id="extxt" class="mb" onclick="ex(this)"><strong>성별로 고등학교 찾기</strong>
                        <p>"남녀공학 / 남고 / 여고"</p>
                    </div>
                    <div id="extxt" onclick="ex(this)"><strong>종합해서 고등학교 찾기</strong>
                        <p>"서울 남녀공학 특성화고" / "경남 일반고 공학"</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="search">
            <input type="text" class="searchbar" placeholder="채팅으로 질문하기" id="searchbar">

            <!-- <img src="send.png" alt="" id="sendimg" onclick="pbchk()"> -->

        </div>
    </div>

    <div id="code" style="display: none;"></div>
    <div id="answertype" style="display: none;"></div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="module" src="src/js/chatpage.js"></script>
</body>

<script>

    // const openDB = () => {
    //     return new Promise((resolve, reject) => {
    //         const request = indexedDB.open('myDatabase', 1);

    //         request.onerror = (event) => {
    //             reject('Failed to open database');
    //         };

    //         request.onsuccess = (event) => {
    //             const db = event.target.result;
    //             resolve(db);
    //         };

    //         request.onupgradeneeded = (event) => {
    //             const db = event.target.result;
    //             if (!db.objectStoreNames.contains('data')) {
    //                 const objectStore = db.createObjectStore('data', { keyPath: 'id' });
    //             }
    //         };
    //     });
    // };

    // const fetchDataFromAPI = async () => {
    //     try {
    //         const response = await axios.get('/.netlify/functions/api');
    //         const data = response.data;
    //         const schinfo = data[0].list;
    //         const stdnt = data[1].list;
    //         const currentTime = new Date().getTime();

    //         const db = await openDB();
    //         const transaction = db.transaction('data', 'readwrite');
    //         const objectStore = transaction.objectStore('data');

    //         await Promise.all([
    //             objectStore.put({ id: 'schinfo', data: schinfo }),
    //             objectStore.put({ id: 'stdnt', data: stdnt }),
    //             objectStore.put({ id: 'lastUpdated', data: currentTime }),
    //         ]);

    //         console.log('Data saved to IndexedDB successfully');
    //         location.reload();
    //     } catch (error) {
    //         alert('오류가 발생했습니다. 새로고침해주세요.\n' + error);
    //         location.reload();
    //     }
    // };

    // const checkAndUpdateData = async () => {
    //     const db = await openDB();
    //     const transaction = db.transaction('data', 'readonly');
    //     const objectStore = transaction.objectStore('data');

    //     const schinfoRequest = objectStore.get('schinfo');
    //     schinfoRequest.onsuccess = (event) => {
    //         const schinfo = event.target.result;

    //         const stdntRequest = objectStore.get('stdnt');
    //         stdntRequest.onsuccess = (event) => {
    //             const stdnt = event.target.result;

    //             const lastUpdatedRequest = objectStore.get('lastUpdated');
    //             lastUpdatedRequest.onsuccess = (event) => {
    //                 const lastUpdated = event.target.result;

    //                 const currentTime = new Date().getTime();
    //                 const oneWeekInMilliseconds = 7 * 24 * 60 * 60 * 1000;

    //                 if (
    //                     schinfo === undefined ||
    //                     stdnt === undefined ||
    //                     lastUpdated === undefined ||
    //                     currentTime - parseInt(lastUpdated.data) >= oneWeekInMilliseconds
    //                 ) {
    //                     fetchDataFromAPI();
    //                 }
    //             };
    //         };
    //     };
    // };

    // checkAndUpdateData();


    function scrollToTop() {
        document.getElementById('chatpage').scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function scrollToBottom() {
        ph = document.getElementById('chatpage').scrollHeight
        document.getElementById('chatpage').scrollTo({
            top: ph,
            behavior: 'smooth'
        });
    }

    // 검색창에 예시 문장 추가하는 함수
    function ex(element) {
        document.getElementById('searchbar').value = element.innerText.replace(/["→]/g, "").trim();
    }

    // 지도와 로드뷰를 감싸고 있는 div의 class를 변경하여 지도를 숨기거나 보이게 하는 함수입니다 
    function toggleMap(active, clickedButton) {
        // 클릭한 버튼 요소의 부모 요소를 찾습니다.
        var container = clickedButton.closest('#container');

        if (container) {
            if (active) {
                container.className = "view_map"; // 지도가 보이도록 클래스 변경
            } else {
                container.className = "view_roadview"; // 로드뷰가 보이도록 클래스 변경
            }
        }
    }

    async function apiupdate() {
        const db = await openDB();
        const transaction = db.transaction('data', 'readwrite');
        const objectStore = transaction.objectStore('data');

        objectStore.delete('schinfo');
        objectStore.delete('stdnt');
        objectStore.delete('lastUpdated');

        window.location.reload();
    }

    const header = document.querySelector('header');
    const toggleButton = document.getElementById('hbgbtn');
    const xbtn = document.getElementById('xbtn');
    const mbblck = document.getElementById('mbblck');
    let isOpen = false;

    // 햄버거 버튼 클릭 이벤트
    toggleButton.addEventListener('click', () => {
        if (!isOpen) {
            header.style.transform = 'translateX(0)';
            toggleButton.style.display = 'none';
            xbtn.style.display = 'block';
            mbblck.style.display = 'block';
            setTimeout(() => {
                xbtn.style.transform = 'translateX(1030%)';
            }, 10);
        }
        isOpen = true;
    });

    // 닫기 버튼 클릭 이벤트
    xbtn.addEventListener('click', () => {
        closeMenu();
    });

    // 메뉴 닫는 기능을 함수로 분리
    function closeMenu() {
        isOpen = false;
        header.style.transform = 'translateX(-100%)';
        toggleButton.style.display = 'block';
        xbtn.style.display = 'none';
        mbblck.style.display = 'none';
    }

    // 화면 크기 변경에 따른 이벤트 리스너
    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            // 화면이 768px 이상이면 메뉴 및 버튼 초기화
            header.style.transform = 'translateX(0)';
            toggleButton.style.display = 'block';
            xbtn.style.display = 'none';
            mbblck.style.display = 'none';
            isOpen = false; // 메뉴 상태 초기화
        } else if (!isOpen) {
            // 화면이 768px 미만이고 메뉴가 닫혀있으면 header 숨기기
            header.style.transform = 'translateX(-100%)';
        }
    });

    // 초기 로드 시 화면 크기 체크
    if (window.innerWidth >= 768) {
        closeMenu(); // 초기 상태에서 화면이 넓으면 메뉴 닫기
    }

</script>

</html>